#!/usr/bin/env python.
# -*- coding: utf-8 -*-

import numpy as np
from numpy import sin
import matplotlib.pyplot as plt


def get_kick(signal, phase, tune, plot=False):

    bpm_nb = orbit.size

    signal_exp = np.concatenate((orbit, orbit))
    phase_exp = np.concatenate((phase-tune*2*pi, phase))
    best_rms = 0


    for i in range(bpm_nb):
        signal_t = signal_exp[i:i+bpm_nb]
        phase_t = phase_exp[i:i+bpm_nb]

        _, b, c = fit_sinus(signal_t, phase_t, False)

        y = b*sin(c + phase_t)
        rms = sum(pow(y-signal_t, 2))
        if rms < best_rms or i == 0:
            best_rms = rms
            idx = i

    if plot:
        plt.figure()
        plt.plot(orbit)
        plt.axvline(idx, -2, 2)

    return

if __name__ == "__main__":
    orbit = np.array([0.591827424810554, 0.666889662879029, 0.541188560583361, 0.841106308255709, 0.894431193472778, 0.607875224295229, -0.210506881459069, -0.568986851419027, -0.664270485441016, -0.414811815063465, -0.525688790784419, -0.425744198652944, -0.158404964814729, 0.526036051370409, 0.966833630090345, 0.957747562235568, 0.691552132132304, 1.00007426033684, 0.973223977292738, 0.558586605779372, -0.505695851790717, -0.929906796615537, -0.951525571383158, -0.692755177335648, -1.00740105476210, -1.01180517881469, -0.569477612544179, 0.0475466852982806, 0.243609827750872, 0.348381814118049, 0.330761264100956, 0.641837979277944, 0.493851427970874, 0.00400067686130368, -0.234103219803544, -0.348460263325079, -0.333410796386311, -0.562354841005319, -0.667031347028741, -0.456624576840466, -0.474559148560161, -0.703521665974611, -0.334160689494460, -0.399368104981632, -0.279780492165516, -0.0250398787274591, 0.509987956108235, 0.676944235553129, 0.575001198576425, 0.332486905206917, 0.399751900191099, 0.291041691876900, 0.0261201525259437, -0.510483700051914, -1.00395009199727, -0.976610992119763, -0.691909533178965, -0.987607448435746, -0.944211868390473, -0.520882197239256, 0.547261172501721, 0.965815623178172, 0.969956346089861, 0.692752894821542, 0.994367756651451, 0.981502266053493, 0.538722820084962, -0.459715265363371, -0.550169931447147, -0.467364415920709, -0.744619190145434, -0.813826547087732, -0.578105887619066, 0.124276561159387, 0.442154338996003, 0.548771902202381, 0.470031830124424, 0.752083510545450, 0.845766326457122, 0.547806264871039, 0.407534708883611, 0.560361403892874, 0.425761234751265, 0.211722023130315, 0.212363815305887, 0.0848917566161412, -0.102885854094760, -0.451937317161523, -0.539271629530577, -0.420164252312771, -0.209530064338778, -0.211007932569514, -0.0883611387193521, 0.0484380845974578, 0.615797681746234, 1.06602698585889, 1.01084949262490, 0.696447223761436, 0.974402270634494, 0.905675811827477, 0.466747857985698, -0.613314302662479, -1.02566727457064, -1.00346406731359, -0.696877127064062, -0.980623789898822, -0.941709076109551, -0.495722055015815])
    phase = np.array([0.874537010351266, 1.00256308325194, 1.13940805672554, 1.23299650924437, 1.35566748539578, 1.59920706516812, 3.75648932955794, 4.01583707066499, 4.14701714119197, 4.28459674800651, 4.37732938162014, 4.49698338689588, 4.65623823601173, 5.95410343248961, 6.11518742646090, 6.24048068308981, 6.37755761871503, 6.47323905687876, 6.60096424046452, 6.86119201038173, 9.01026641525718, 9.25652550940378, 9.38492433305304, 9.52281399754911, 9.61767621564690, 9.74229570200982, 9.91163067634297, 11.2769579592268, 11.4301063406592, 11.5470577646204, 11.6734833824650, 11.8779701925533, 12.1175901896279, 14.3358388121719, 14.5714866105753, 14.6913113153966, 14.8184545016852, 14.9053719658032, 15.0193511139916, 15.1748249059648, 16.5623742950623, 16.7294259156310, 16.9907936223236, 17.0829713146109, 17.2037776007232, 17.4439966730008, 19.6135960156623, 19.8708170789459, 20.0003573068729, 20.1359763836181, 20.2273183975486, 20.3451813702388, 20.5808141771110, 21.7227741416124, 21.9679140503739, 22.0949094912404, 22.2335428114618, 22.3300585548574, 22.4585144397749, 22.7187748594777, 24.8594627446964, 25.1093357295984, 25.2394462706813, 25.3788845783642, 25.4745759736113, 25.5999345894774, 25.7695875696040, 27.3777286905565, 27.5068900329810, 27.6453971150437, 27.7403251509414, 27.8649100533700, 28.1124017930688, 30.2591969440564, 30.5191832159621, 30.6514751291841, 30.7907199672796, 30.8848000600320, 31.0063725389953, 31.1683429917423, 32.4692698078460, 32.6277618417985, 32.7509423931628, 32.8857994755645, 32.9800697474853, 33.1061860939774, 33.3645489325670, 35.5270018509981, 35.7692520980509, 35.8954353207069, 36.0310833384524, 36.1245684596641, 36.2476750478679, 36.4156741362611, 37.7964761727812, 37.9510171984220, 38.0685100411090, 38.1949974068921, 38.2823927299888, 38.3984366690343, 38.6353337214127, 40.8546561041289, 41.0925384134754, 41.2128621740862, 41.3400408463647, 41.4266868131954, 41.5399612950104, 41.6939326627645])
    tune = 6.742330122301768

    get_kick(orbit, phase, tune, True)
